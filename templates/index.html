<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="/static/bootstrap.min.css" />
		<script src="/static/jquery.min.js"></script>
		<script src="/static/bootstrap.min.js"></script>

		<script>
		//XHR Object for sending the server Async Requests working.
		var XHR;
		
		//How fast the Robot will move
		var MovementSpeed = 1.0;

		//CONSTANTS
		IO_REQUEST_PAGE = "/ioState";

		//Keyboard KeyCodes
		KEY_W = 87;
		KEY_A = 65;
		KEY_S = 83;
		KEY_D = 68;

		KEY_UP = 38;
		KEY_LEFT = 37;
		KEY_DOWN = 40;
		KEY_RIGHT = 39;

		/**
		 * sendMotorSpeed
		 * Send command to motors to spin in a particular direction
		 */

		//TODO: One for servos, one for mode, etc.
		function sendMotorSpeed(motor1Speed, motor2Speed) {
			var query = IO_REQUEST_PAGE + "?motor1Speed=" + motor1Speed + "&motor2Speed=" + motor2Speed;
			
			XHR.open('GET', query);
			XHR.send();
		}
		
		function sendMode() {
			var query = IO_REQUEST_PAGE + "?togglemode";
			XHR.open('GET', query);
			XHR.send();
		}

		function goForward() {
			sendMotorSpeed(1 * MovementSpeed, 1 * MovementSpeed);
		}

		function goBackward() {
			sendMotorSpeed(-1 * MovementSpeed, -1 * MovementSpeed);
		}

		function turnLeft() {
			sendMotorSpeed(-1 * MovementSpeed, 1 * MovementSpeed);
		}

		function turnRight() {
			sendMotorSpeed(1 * MovementSpeed, -1 * MovementSpeed);
		}

		function stop() {
			sendMotorSpeed(0, 0);
		}
		
		function arm_position_raised() {
			var query = IO_REQUEST_PAGE + "?action=arm_raise";
			XHR.open('GET', query);
			XHR.send();
		}
		
		function arm_position_lowered() {
			var query = IO_REQUEST_PAGE + "?action=arm_lower";
			XHR.open('GET', query);
			XHR.send();
		}
		
		function arm_clawToggle() {
			var query = IO_REQUEST_PAGE + "?action=claw_toggle";
			XHR.open('GET', query);
			XHR.send();
		}
		
		function clickAndTouch(elem, pressFn, releaseFn) {
			document.getElementById(elem).addEventListener('mousedown', pressFn);
			document.getElementById(elem).addEventListener('touchstart', pressFn);

			document.getElementById(elem).addEventListener('mouseup', releaseFn);
			document.getElementById(elem).addEventListener('touchend', releaseFn);
			document.getElementById(elem).addEventListener('touchcancel', releaseFn);
		}

		function setEventToDirectionButton(elem, fn) {
			document.getElementById(elem).addEventListener('mousedown', fn);
			document.getElementById(elem).addEventListener('touchstart', fn);

			document.getElementById(elem).addEventListener('mouseup', stop);
			document.getElementById(elem).addEventListener('touchend', stop);
			document.getElementById(elem).addEventListener('touchcancel', stop);
		}

		function loaded() {
			XHR = new XMLHttpRequest();
			
			// ---- Forward button ----
			setEventToDirectionButton('up', goForward);
			
			// ---- Backward button ----
			setEventToDirectionButton('down', goBackward);

			// ---- Rotate Right ----
			setEventToDirectionButton('right', turnRight);
			
			// ---- Rotate Left ----
			setEventToDirectionButton('left', turnLeft);
			
			clickAndTouch('arm_lift', ()=>{}, arm_position_raised);
			clickAndTouch('arm_lower', ()=>{}, arm_position_lowered);
			clickAndTouch('arm_claw_toggle', ()=>{}, arm_clawToggle);
			

			// ---- Keyboard ----
			window.addEventListener('keydown', function(e) {
				switch(e.keyCode) {
					case KEY_W:
					case KEY_UP:
						goForward();
						break;
					case KEY_A:
					case KEY_LEFT:
						turnLeft();
						break;
					case KEY_S:
					case KEY_DOWN:
						goBackward();
						break;
					case KEY_D:
					case KEY_RIGHT:
						turnRight();
						break;
				}
			});

			window.addEventListener('keyup', function(e) {
				switch(e.keyCode) {
					case KEY_W:
					case KEY_A:
					case KEY_S:
					case KEY_D:
					case KEY_UP:
					case KEY_DOWN:
					case KEY_LEFT:
					case KEY_RIGHT:
						stop();
						break;
				}
			});
			
			document.getElementById("auto_manual").addEventListener("click", sendMode);
		}
			
		window.addEventListener('load', loaded);
		</script>
	</head>
	<body>
		<div class="container">
			<div class="row">
				<!-- Movement Controls -->
				<div class="col-sm-4">
					<table class="table">
						<tr>
							<td></td>
							<td>
								<button class="btn btn-default btn-lg btn-block" id="up">&#8593</button>
							</td>
							<td></td>
						</tr>
						
						<tr>
							<td><button class="btn btn-default btn-lg btn-block" id="left">&#8592</button></td>
							<td><button class="btn btn-default btn-lg btn-block" id="auto_manual">Mode</button></td>
							<td><button class="btn btn-default btn-lg btn-block" id="right">&#8594</button></td>
						</tr>
						
						<tr>
							<td></td>
								<td>
									<button class="btn btn-default btn-lg btn-block" id="down">&#8595</button>
								</td>
							<td></td>
						</tr>
					</table>
				</div>

				<!-- MJPEG Video Stream -->
				<div class="col-sm-4">
					
				</div>
				
				<!-- Arm Controls -->
				<div class="col-sm-4">
					<div class="row">
						<div class="col-3">
							<button class="btn btn-default" id="arm_lift">Lift arm</button>
						</div>
						<div class="col-3">
							<button class="btn btn-default" id="arm_lower">Lower arm</button>
						</div>
						<div class="col-3">
							<button class="btn btn-default" id="arm_claw_toggle">Claw</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>
